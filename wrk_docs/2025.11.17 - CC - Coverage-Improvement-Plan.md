# Code Coverage Improvement Plan: MDSORTO

**Date:** 2025-11-17
**Current Coverage:** 42.72% (lines)
**Target Coverage:** 98%
**Gap to Close:** +55.28%

---

## Overview

This document outlines a systematic, multi-phase approach to improve code coverage from the current 42.72% to the target 98%. The plan is designed to be implemented incrementally, with each phase building on the previous one.

---

## Success Criteria

✅ **Primary Goal:** Achieve ≥98% line coverage
✅ **Secondary Goal:** Achieve ≥95% function coverage
✅ **Tertiary Goal:** Achieve ≥90% region coverage

**Constraints:**
- All tests must pass
- No reduction in existing coverage
- Tests must be maintainable and clear
- Focus on meaningful tests, not just coverage numbers

---

## Phase 1: Event Handling System
**Target Coverage Increase:** +20% (42.72% → 63%)
**Estimated Effort:** 2-3 hours
**Priority:** CRITICAL

### Objective
Test the complete event handling pipeline from keyboard input to state changes.

### Components to Test

#### 1.1 Event Enum Coverage
**File:** src/main.rs:64-68
```rust
pub enum Event {
  Error,   // ← Need test
  Tick,    // ← Need test
  Key(KeyEvent),  // ← Partially tested
}
```

**Tests to Add:**
- Event::Error creation and handling
- Event::Tick creation and handling
- Event::Key with various KeyEvent types

#### 1.2 handle_event() Function
**File:** src/main.rs:182-199

**Tests to Add:**
```rust
#[test]
fn test_handle_event_quit_q()
fn test_handle_event_quit_uppercase_q()
fn test_handle_event_quit_escape()
fn test_handle_event_pause_p()
fn test_handle_event_pause_uppercase_p()
fn test_handle_event_space()
fn test_handle_event_enter()
fn test_handle_event_back_b()
fn test_handle_event_back_uppercase_b()
fn test_handle_event_restart_r()
fn test_handle_event_restart_uppercase_r()
fn test_handle_event_extra_equals()
fn test_handle_event_extra_plus()
fn test_handle_event_lose_minus()
fn test_handle_event_lose_underscore()
fn test_handle_event_unknown_key()  // Default case
fn test_handle_event_tick()
fn test_handle_event_error()
```

**Total:** 18 new tests

#### 1.3 update() Message Dispatch
**File:** src/main.rs:201-213

**Tests to Add:**
```rust
#[test]
fn test_update_start_or_next_message()
fn test_update_pause_message()
fn test_update_back_message()
fn test_update_extra10_message()
fn test_update_lose10_message()
fn test_update_restart_message()
fn test_update_tick_message()
fn test_update_quit_message()
```

**Total:** 8 new tests

### Expected Coverage After Phase 1
- Lines: ~63%
- New tests: 26
- Functions covered: +9

---

## Phase 2: UI Logic & Rendering
**Target Coverage Increase:** +15% (63% → 78%)
**Estimated Effort:** 3-4 hours
**Priority:** HIGH

### Objective
Test UI widget creation logic and state-dependent rendering decisions.

### Components to Test

#### 2.1 layout() Function
**File:** src/main.rs:297-311

**Tests to Add:**
```rust
#[test]
fn test_layout_creates_five_sections()
fn test_layout_section_heights()
fn test_layout_respects_area_bounds()
```

**Total:** 3 new tests

#### 2.2 title_paragraph() Function
**File:** src/main.rs:313-318

**Tests to Add:**
```rust
#[test]
fn test_title_paragraph_content()
fn test_title_paragraph_style_is_gray()
```

**Total:** 2 new tests

#### 2.3 person_paragraph() Function
**File:** src/main.rs:320-331

**Tests to Add:**
```rust
#[test]
fn test_person_paragraph_prep_time_is_blue()
fn test_person_paragraph_regular_person_is_gray()
fn test_person_paragraph_displays_current_person_name()
```

**Total:** 3 new tests

#### 2.4 timer_paragraph() Color Logic
**File:** src/main.rs:333-350

**Tests to Add:**
```rust
#[test]
fn test_timer_paragraph_paused_is_gray()
fn test_timer_paragraph_running_plenty_time_is_green()  // > 20s
fn test_timer_paragraph_running_warning_is_yellow()     // 7.5-20s
fn test_timer_paragraph_running_critical_is_red()       // < 7.5s
fn test_timer_paragraph_formats_time_correctly()
```

**Total:** 5 new tests

#### 2.5 people_list() Function
**File:** src/main.rs:352-355

**Tests to Add:**
```rust
#[test]
fn test_people_list_excludes_prep_time()
fn test_people_list_formats_with_spaces()
fn test_people_list_handles_single_person()
fn test_people_list_handles_many_people()
```

**Total:** 4 new tests

#### 2.6 help_paragraph() Dynamic Text
**File:** src/main.rs:357-365

**Tests to Add:**
```rust
#[test]
fn test_help_paragraph_shows_start_when_paused()
fn test_help_paragraph_shows_next_when_running()
fn test_help_paragraph_shows_quit_at_last_person()
fn test_help_paragraph_hides_back_at_first_person()
fn test_help_paragraph_shows_back_after_first_person()
```

**Total:** 5 new tests

#### 2.7 ui() Integration
**File:** src/main.rs:287-295

**Tests to Add:**
```rust
#[test]
fn test_ui_calls_all_render_functions()
```

**Total:** 1 new test

### Expected Coverage After Phase 2
- Lines: ~78%
- New tests: 23
- Functions covered: +7

---

## Phase 3: Tick & Time Simulation
**Target Coverage Increase:** +8% (78% → 86%)
**Estimated Effort:** 2 hours
**Priority:** HIGH

### Objective
Test time-based logic and automatic state progression.

### Components to Test

#### 3.1 tick() Function
**File:** src/main.rs:264-272

**Challenge:** Needs time mocking or acceptance of actual delays

**Strategy:** Create helper to advance time and test behavior

**Tests to Add:**
```rust
#[test]
fn test_tick_decrements_time_when_running()
fn test_tick_does_not_decrement_when_paused()
fn test_tick_auto_advances_when_time_reaches_zero()
fn test_tick_calls_next_person_on_timeout()
fn test_tick_handles_negative_time()
```

**Total:** 5 new tests

**Implementation Note:** May need to refactor tick() to accept elapsed duration as parameter for testability.

### Expected Coverage After Phase 3
- Lines: ~86%
- New tests: 5
- Functions covered: +1

---

## Phase 4: Configuration Loading & Initialization
**Target Coverage Increase:** +7% (86% → 93%)
**Estimated Effort:** 3 hours
**Priority:** MEDIUM

### Objective
Test config file handling, parsing, and error recovery.

### Components to Test

#### 4.1 Config File Loading
**File:** src/main.rs:128-136

**Tests to Add:**
```rust
#[test]
fn test_config_file_not_found_uses_defaults()
fn test_config_file_empty_uses_defaults()
fn test_config_file_invalid_format_uses_defaults()
```

**Total:** 3 new tests

#### 4.2 Config Section Parsing
**File:** src/main.rs:144-193

**Tests to Add:**
```rust
#[test]
fn test_config_missing_mdsorto_section()
fn test_config_missing_timeeach_uses_default()
fn test_config_missing_preptime_uses_default()
fn test_config_missing_people_uses_default()
fn test_config_valid_timeeach()
fn test_config_valid_preptime()
fn test_config_valid_people_list()
fn test_config_people_with_spaces()
fn test_config_people_with_empty_names()
fn test_config_people_exceeds_max_people()
fn test_config_people_only_commas()
fn test_config_ensures_minimum_people()
```

**Total:** 12 new tests

**Implementation Note:** These tests will need to create temporary .ini files or mock the ini! macro.

#### 4.3 People List Shuffling
**File:** src/main.rs:196

**Tests to Add:**
```rust
#[test]
fn test_people_list_shuffles_excluding_prep_time()
fn test_people_list_first_element_always_prep_time()
```

**Total:** 2 new tests

### Expected Coverage After Phase 4
- Lines: ~93%
- New tests: 17
- Functions covered: +3

---

## Phase 5: Tui Infrastructure & Lifecycle
**Target Coverage Increase:** +3% (93% → 96%)
**Estimated Effort:** 2 hours
**Priority:** LOW (harder to test)

### Objective
Test terminal UI setup, teardown, and event loop basics.

### Components to Test

#### 5.1 Tui::new()
**File:** src/main.rs:377-384

**Tests to Add:**
```rust
#[test]
fn test_tui_new_creates_terminal()
fn test_tui_new_creates_channels()
fn test_tui_new_creates_cancellation_token()
```

**Total:** 3 new tests

#### 5.2 Tui::next()
**File:** src/main.rs:386-388

**Tests to Add:**
```rust
#[test]
async fn test_tui_next_receives_events()
```

**Total:** 1 new test

#### 5.3 Drop Implementation
**File:** src/main.rs:478-485

**Tests to Add:**
```rust
#[test]
fn test_tui_drop_calls_exit()
fn test_tui_drop_handles_error_gracefully()
```

**Total:** 2 new tests

### Expected Coverage After Phase 5
- Lines: ~96%
- New tests: 6
- Functions covered: +2

---

## Phase 6: Edge Cases & Error Paths
**Target Coverage Increase:** +2% (96% → 98%)
**Estimated Effort:** 2 hours
**Priority:** MEDIUM

### Objective
Cover remaining error paths and edge cases.

### Components to Test

#### 6.1 Logger Initialization Errors
**File:** src/main.rs:108-122

**Tests to Add:**
```rust
#[test]
fn test_log_file_creation_failure_fallback()
fn test_logger_init_failure_continues()
```

**Total:** 2 new tests

#### 6.2 Event Send Error Paths
**File:** src/main.rs:445-462

**Tests to Add:**
```rust
#[test]
fn test_event_send_error_logged()
```

**Total:** 1 new test

#### 6.3 Boundary Conditions
**Tests to Add:**
```rust
#[test]
fn test_max_people_boundary()
fn test_min_time_boundary()
fn test_max_time_boundary()
fn test_empty_app_people_list()
```

**Total:** 4 new tests

### Expected Coverage After Phase 6
- Lines: ~98%
- New tests: 7
- Functions covered: +1

---

## Summary by Phase

| Phase | Focus Area | Coverage Δ | New Tests | Effort | Priority |
|-------|-----------|-----------|-----------|--------|----------|
| 1 | Event Handling | +20% | 26 | 2-3h | CRITICAL |
| 2 | UI Logic | +15% | 23 | 3-4h | HIGH |
| 3 | Time Simulation | +8% | 5 | 2h | HIGH |
| 4 | Config Loading | +7% | 17 | 3h | MEDIUM |
| 5 | Tui Infrastructure | +3% | 6 | 2h | LOW |
| 6 | Edge Cases | +2% | 7 | 2h | MEDIUM |
| **TOTAL** | **All** | **+55.28%** | **84** | **14-16h** | - |

---

## Implementation Order

### Week 1: Critical Path
**Day 1-2:** Phase 1 (Event Handling)
- Morning: Tests 1-13
- Afternoon: Tests 14-26
- Verify coverage reaches ~63%

**Day 3-4:** Phase 2 (UI Logic)
- Morning: Layout, title, person tests
- Afternoon: Timer, people, help tests
- Verify coverage reaches ~78%

### Week 2: Complete Coverage
**Day 5:** Phase 3 (Time Simulation)
- Implement tick tests
- Verify coverage reaches ~86%

**Day 6:** Phase 4 (Config Loading)
- Morning: Config file tests
- Afternoon: People parsing tests
- Verify coverage reaches ~93%

**Day 7:** Phases 5 & 6 (Final Push)
- Morning: Tui infrastructure tests
- Afternoon: Edge cases and error paths
- **Verify coverage reaches ≥98%**

---

## Test Infrastructure Additions

### Dependencies to Add
```toml
[dev-dependencies]
tokio-test = "0.4"      # For async test support
tempfile = "3.0"        # For config file tests
assert_matches = "1.5"  # Better assertions
```

### Helper Utilities to Create

#### 1. Event Builder
```rust
#[cfg(test)]
mod test_helpers {
    use crossterm::event::{KeyCode, KeyEvent, KeyModifiers};

    pub fn key_event(code: KeyCode) -> KeyEvent {
        KeyEvent::new(code, KeyModifiers::empty())
    }
}
```

#### 2. Mock Frame for UI Tests
```rust
#[cfg(test)]
struct MockFrame {
    // Minimal implementation for testing
}
```

#### 3. Temp Config Builder
```rust
#[cfg(test)]
fn create_test_config(contents: &str) -> tempfile::NamedTempFile {
    // Helper to create temp .ini files
}
```

---

## Risk Mitigation

### Risk 1: Async Code Hard to Test
**Mitigation:** Use `tokio::test` and `tokio_test::block_on()`

### Risk 2: UI Code Requires Mocking
**Mitigation:** Test logic only, not actual rendering. Create minimal mock frame.

### Risk 3: Time-Based Tests Are Flaky
**Mitigation:** Refactor tick() to accept duration parameter for testing

### Risk 4: Terminal Operations Can't Be Unit Tested
**Mitigation:** Mark as `#[cfg(not(coverage))]` or accept <98% on those specific lines

---

## Coverage Exclusions

### Acceptable to Exclude (<2% of code)
```rust
#[cfg(not(tarpaulin_include))]
fn enter(&mut self) -> Result<()> {
    // Terminal raw mode - hard to test
}

#[cfg(not(tarpaulin_include))]
fn exit(&self) -> Result<()> {
    // Terminal cleanup - hard to test
}
```

---

## Verification Steps

After each phase:
1. Run tests: `cargo test`
2. Check coverage: `cargo llvm-cov --all-features --workspace`
3. Generate HTML: `cargo llvm-cov --all-features --workspace --html`
4. Review uncovered lines: `open target/llvm-cov/html/index.html`
5. Update this plan with actual results

---

## Success Metrics

### Definition of Done
- ✅ Coverage ≥ 98% (line coverage)
- ✅ All tests pass
- ✅ No flaky tests
- ✅ Tests are well-documented
- ✅ Coverage report generated
- ✅ CI integration (optional)

### Progress Tracking
```
Current:  ████████████░░░░░░░░░░░░░░░░░░  42.72%
Phase 1:  ████████████████████░░░░░░░░░░  63%
Phase 2:  ███████████████████████░░░░░░░  78%
Phase 3:  █████████████████████████░░░░░  86%
Phase 4:  ███████████████████████████░░░  93%
Phase 5:  ████████████████████████████░░  96%
Phase 6:  ████████████████████████████░░  98%
Target:   ██████████████████████████████  98%
```

---

## Maintenance Plan

### After Reaching 98%
1. Add coverage badge to README
2. Set up coverage gates in CI (fail if <95%)
3. Review coverage monthly
4. Update tests when adding features
5. Never let coverage drop below 95%

---

## Conclusion

This plan provides a clear, systematic path to improve coverage from 42.72% to 98% through 6 focused phases. By following this plan, we will:
- Increase confidence in code correctness
- Enable safe refactoring
- Prevent regressions
- Meet industry standards for test coverage

**Next Step:** Begin Phase 1 implementation.

---

*End of Coverage Improvement Plan*
