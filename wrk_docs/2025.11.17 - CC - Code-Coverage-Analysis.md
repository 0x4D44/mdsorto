# Code Coverage Analysis Report: MDSORTO

**Date:** 2025-11-17
**Project:** MDSORTO v0.3.1
**Tool:** cargo-llvm-cov 0.6.21
**Analysis Type:** Comprehensive code coverage review

---

## Executive Summary

**Current Coverage Status: LOW**

| Metric | Covered | Total | Percentage | Target | Gap |
|--------|---------|-------|------------|--------|-----|
| **Lines** | 220 | 515 | **42.72%** | 98% | -55.28% |
| **Functions** | 36 | 73 | **49.32%** | 98% | -48.68% |
| **Regions** | 293 | 876 | **33.45%** | 98% | -64.55% |

**Overall Assessment:** The current test suite provides **basic unit test coverage** of core logic functions but **lacks coverage** of:
- Event handling system
- UI rendering pipeline
- Integration/initialization code
- Error handling paths
- Async runtime interactions

---

## Detailed Coverage Breakdown

### ✅ Well-Covered Components (>90% coverage)

#### 1. Core Timer Logic
**Lines Covered:** ~95%
- ✅ `extra10()` - Time addition
- ✅ `lose10()` - Time subtraction with minimum clamping
- ✅ `restart()` - Timer reset
- ✅ `format_timeleft()` - Time formatting
- ✅ `parse_time_config()` - Config validation

**Test Coverage:**
```
test_extra10
test_lose10
test_lose10_minimum
test_restart
test_format_timeleft
test_parse_time_config_* (7 tests)
```

#### 2. State Management
**Lines Covered:** ~90%
- ✅ `pause()` / `unpause()` / `pausetoggle()`
- ✅ `quit()`
- ✅ State transitions

**Test Coverage:**
```
test_pause_unpause
test_pausetoggle
test_quit
```

#### 3. Navigation Logic
**Lines Covered:** ~85%
- ✅ `next_person()` - Forward navigation
- ✅ `back()` - Backward navigation with boundary checks
- ✅ End-of-list handling

**Test Coverage:**
```
test_next_person_advances
test_next_person_quits_at_end
test_back_at_start
test_back_from_second_person
test_back_to_prep_time
```

#### 4. Basic App Creation
**Lines Covered:** ~80%
- ✅ `CountdownApp::new()`
- ✅ `Default` trait implementation

**Test Coverage:**
```
test_default_app_creation
test_start_or_next_when_paused
test_start_or_next_when_running
```

---

### ❌ Uncovered Components (0-30% coverage)

#### 1. Event Handling System (Estimated: 5% coverage)
**Location:** Lines 182-213

**Uncovered Functions:**
- `handle_event()` - Keyboard event translation
- `update()` - Message dispatch to handlers
- Event enum variants usage

**Missing Tests:**
- Keyboard input mapping (q, p, space, r, b, +, -, Esc)
- Message routing
- Invalid key handling

**Impact:** **CRITICAL** - Core interaction mechanism untested

---

#### 2. UI Rendering Pipeline (Estimated: 0% coverage)
**Location:** Lines 287-365

**Uncovered Functions:**
- `ui()` - Main render function
- `layout()` - Screen layout calculation
- `title_paragraph()` - Title rendering
- `person_paragraph()` - Person name display
- `timer_paragraph()` - Timer display with color coding
- `people_list()` - Participant list rendering
- `help_paragraph()` - Help text rendering

**Missing Tests:**
- Widget creation and styling
- Color state changes (gray/blue/green/yellow/red)
- Layout calculations
- Text rendering

**Impact:** **HIGH** - Entire UI layer untested

---

#### 3. Initialization & Configuration Loading (Estimated: 10% coverage)
**Location:** Lines 106-196

**Uncovered Paths:**
- `run()` async function
- Logger initialization (success/failure paths)
- Config file loading (success/failure/missing)
- Config section parsing
- People list parsing with edge cases
- Default value fallback
- Person shuffling

**Missing Tests:**
- Config file not found
- Config file malformed
- Empty people list
- People list with only spaces/commas
- MAX_PEOPLE limit enforcement
- Logger creation failures
- Shuffling behavior

**Impact:** **HIGH** - Application startup untested

---

#### 4. Tui Infrastructure (Estimated: 0% coverage)
**Location:** Lines 368-485

**Uncovered Components:**
- `Tui::new()` - Terminal initialization
- `Tui::enter()` / `Tui::exit()` - Raw mode handling
- `Tui::start()` - Event loop spawning
- `Tui::stop()` - Cleanup
- `Tui::next()` - Event reception
- Event stream handling
- Cancellation token usage
- Drop implementation

**Missing Tests:**
- Terminal setup/teardown
- Event loop lifecycle
- Async event handling
- Cleanup on drop
- Timeout handling

**Impact:** **MEDIUM** - Infrastructure untested but harder to unit test

---

#### 5. Main Function & Integration (Estimated: 0% coverage)
**Location:** Lines 72-76

**Uncovered:**
- `main()` - Entry point
- Full application lifecycle
- Integration between components

**Missing Tests:**
- End-to-end application flow
- Component interaction
- Error propagation

**Impact:** **MEDIUM** - Integration untested

---

#### 6. Tick Function (Estimated: 40% coverage)
**Location:** Lines 264-272

**Partially Covered:**
- ✅ State check (paused vs running)
- ❌ Time calculation with Instant
- ❌ Auto-advance on timeout

**Missing Tests:**
- Time passage simulation
- Auto-advance when time_left <= 0
- Paused state time freeze

**Impact:** **MEDIUM** - Core timer mechanism partially untested

---

## Coverage Gaps by Category

### 1. Async/Runtime Code (0% coverage)
- **Lines:** ~80
- **Reason:** Requires tokio test harness
- **Functions:** `main()`, `run()`, event loop in `Tui::start()`

### 2. UI/Rendering Code (0% coverage)
- **Lines:** ~70
- **Reason:** Difficult to test without mocking ratatui
- **Functions:** All `*_paragraph()` functions, `ui()`, `layout()`

### 3. Event Handling (5% coverage)
- **Lines:** ~30
- **Reason:** Needs event injection testing
- **Functions:** `handle_event()`, `update()`

### 4. Initialization/Config (10% coverage)
- **Lines:** ~90
- **Reason:** Needs file system mocking
- **Functions:** Config loading in `run()`

### 5. Error Paths (20% coverage)
- **Lines:** ~45
- **Reason:** Error conditions not triggered
- **Functions:** Error handlers in config parsing, logging

---

## Testability Analysis

### High Testability (Easy to test)
- ✅ Pure functions (timer logic, formatting)
- ✅ State management
- ✅ Navigation logic
- ✅ Config parsing (already has good tests)

### Medium Testability (Requires mocking/setup)
- ⚠️ Event handling
- ⚠️ Tick function with time passage
- ⚠️ Config file loading
- ⚠️ UI rendering (can test logic, not actual rendering)

### Low Testability (Hard to unit test)
- ⛔ Async runtime initialization
- ⛔ Terminal raw mode operations
- ⛔ Event loop with tokio::select!
- ⛔ Drop implementation side effects

---

## Root Cause Analysis

### Why Coverage Is Low

1. **Test Focus:** Current tests focus on **pure logic functions** only
2. **Missing Integration Tests:** No tests for component interaction
3. **No Mocking:** UI and I/O operations not mocked
4. **Async Not Tested:** Tokio runtime not used in tests
5. **Error Paths Ignored:** Happy path only in most tests

### What's Actually Being Tested

The current test suite validates:
- ✅ Timer arithmetic (add/subtract time)
- ✅ State machine transitions
- ✅ Navigation boundary conditions
- ✅ Config validation logic
- ✅ Time formatting

### What's NOT Being Tested

- ❌ Event flow from keyboard to state change
- ❌ UI updates based on state
- ❌ Config file I/O
- ❌ Logger initialization
- ❌ Terminal operations
- ❌ Async event loop
- ❌ Integration between components
- ❌ Error recovery

---

## Impact Assessment

### Risk Level: MODERATE

**Production Readiness:** 60%

**Risks:**
1. **High Risk:** Event handling bugs could make app unusable
2. **Medium Risk:** UI rendering issues might not display correctly
3. **Medium Risk:** Config loading failures not properly handled
4. **Low Risk:** Core timer logic is well-tested

**Confidence:**
- ✅ **High confidence** in timer and navigation logic
- ⚠️ **Medium confidence** in state management
- ❌ **Low confidence** in UI rendering correctness
- ❌ **Low confidence** in initialization/error handling
- ❌ **Very low confidence** in event system

---

## Improvement Opportunities

### Quick Wins (Can reach 60-70% coverage)
1. Add event handling tests (11 keyboard inputs)
2. Test `update()` message dispatch
3. Test `handle_event()` key mapping
4. Add `tick()` tests with time simulation

### Medium Effort (Can reach 80-90% coverage)
5. Mock UI functions to test logic
6. Test config loading with temp files
7. Test error paths in initialization
8. Test `Tui::new()` and setup

### High Effort (Can reach 95-98% coverage)
9. Integration tests with tokio_test
10. Test async run() function
11. Test event loop behavior
12. Test terminal operations (hard)

---

## Recommended Testing Strategy

### Phase 1: Event & Message System (Target: +20% coverage)
- Test all keyboard event mappings
- Test message dispatch
- Test event-to-state-change flow

### Phase 2: Tick & Time Simulation (Target: +10% coverage)
- Mock Instant for time control
- Test auto-advance on timeout
- Test pause behavior during ticks

### Phase 3: UI Logic Testing (Target: +15% coverage)
- Test widget creation (not rendering)
- Test color selection logic
- Test layout calculations
- Test text formatting in paragraphs

### Phase 4: Config & Initialization (Target: +15% coverage)
- Test config file variations (missing, empty, invalid)
- Test logger fallbacks
- Test people list parsing edge cases
- Test shuffling

### Phase 5: Integration & Async (Target: +10% coverage)
- Test component interactions
- Test async `run()` with tokio::test
- Test Tui lifecycle

### Phase 6: Error Paths & Edge Cases (Target: +8% coverage)
- Test all error handling branches
- Test resource cleanup
- Test boundary conditions

**Projected Coverage After All Phases: 98%+**

---

## Tools & Techniques Needed

### For Testing
1. **tokio::test** - Async test support
2. **mockall** or **mockito** - Mocking framework
3. **tempfile** - Temporary config files
4. **assert_matches** - Better assertions
5. **proptest** - Property-based testing (optional)

### For Coverage
1. ✅ **cargo-llvm-cov** - Already in use
2. **cargo-watch** - Continuous testing
3. **HTML reports** - Visual coverage inspection

---

## Metrics to Track

| Milestone | Target Coverage | Functions Covered | Tests Required (est.) |
|-----------|----------------|-------------------|----------------------|
| Current | 42.72% | 36/73 | 23 |
| Phase 1 | 63% | 45/73 | +15 tests |
| Phase 2 | 73% | 52/73 | +8 tests |
| Phase 3 | 88% | 62/73 | +12 tests |
| Phase 4 | 93% | 68/73 | +10 tests |
| Phase 5 | 96% | 71/73 | +5 tests |
| Phase 6 | **98%** | 72/73 | +3 tests |
| **TOTAL** | **98%** | **72/73** | **~76 tests** |

---

## Uncoverable Code

### Acceptable Exclusions (<2% of code)
1. **main()** - Entry point (can be tested but low value)
2. **Terminal raw mode** - System calls (hard to test reliably)
3. **Drop side effects** - Cleanup code (tested implicitly)

These can be marked with `#[cfg(not(coverage))]` or similar.

---

## Recommendations

### Immediate Actions (This Sprint)
1. ✅ Install coverage tools (DONE)
2. ✅ Generate baseline report (DONE)
3. ⬜ Add event handling tests
4. ⬜ Add tick simulation tests
5. ⬜ Add UI logic tests

### Short Term (Next Sprint)
6. ⬜ Add config file tests
7. ⬜ Add integration tests
8. ⬜ Set up CI coverage tracking

### Long Term (Continuous)
9. ⬜ Maintain >98% coverage
10. ⬜ Add coverage gates to CI/CD
11. ⬜ Regular coverage audits

---

## Conclusion

The MDSORTO project has **solid unit test coverage of core logic** (timer, navigation, state) but **lacks coverage of the integration layer**, UI, and I/O operations.

**Current State:** Basic unit tests only
**Target State:** Comprehensive coverage including integration

**Path Forward:** Follow the 6-phase improvement plan to achieve 98% coverage through systematic addition of tests for event handling, UI logic, configuration, and integration flows.

**Estimated Effort:** 2-3 days of focused test development

**Value:** High - Will significantly increase confidence in correctness and prevent regressions

---

## Appendix A: Coverage Command Reference

### Generate Coverage Report
```bash
cargo llvm-cov --all-features --workspace
```

### Generate HTML Report
```bash
cargo llvm-cov --all-features --workspace --html
```

### View Report
```bash
open target/llvm-cov/html/index.html
```

### Generate Summary
```bash
cargo llvm-cov --all-features --workspace --summary-only
```

---

## Appendix B: Current Test List

1. test_default_app_creation
2. test_extra10
3. test_lose10
4. test_lose10_minimum
5. test_back_at_start
6. test_back_from_second_person
7. test_back_to_prep_time
8. test_next_person_advances
9. test_next_person_quits_at_end
10. test_restart
11. test_pause_unpause
12. test_pausetoggle
13. test_quit
14. test_start_or_next_when_paused
15. test_start_or_next_when_running
16. test_format_timeleft
17. test_parse_time_config_valid
18. test_parse_time_config_too_low
19. test_parse_time_config_too_high
20. test_parse_time_config_invalid
21. test_parse_time_config_negative
22. test_parse_time_config_at_min_boundary
23. test_parse_time_config_at_max_boundary

**Total:** 23 tests

---

*End of Coverage Analysis Report*
